--silver dimension table load 
TRUNCATE TABLE silver.fact_treatment_action;
TRUNCATE TABLE silver.dim_patient CASCADE;
SELECT * FROM silver.dim_patient LIMIT 10;

WITH dedup_bronze AS (
    -- 1️⃣ pick the latest version of patient per source
    SELECT *
    FROM (
        SELECT
            b.*,
            ROW_NUMBER() OVER (
                PARTITION BY b.patient_id, b._source_system
                ORDER BY
                    b.treatment_action_processed_at DESC NULLS LAST,
                    b.index_no DESC
            ) AS rn
        FROM bronze.bronze_patient_treatment_actions b
        WHERE b.patient_id IS NOT NULL
    ) x
    WHERE rn = 1
),

normalized_bronze AS (
    -- 2️⃣ normalize & clean patient attributes
    SELECT
        b.patient_id,
        TRIM(NULLIF(b.patient_id_with_prefix, '')) AS patient_id_with_prefix,

        TRIM(
            REGEXP_REPLACE(
                REGEXP_REPLACE(NULLIF(b.patient_name, ''), '[\.,\-]', ' ', 'g'),
                '\s+', ' ', 'g'
            )
        ) AS patient_name,

        LOWER(TRIM(NULLIF(b.patient_email_id, ''))) AS patient_email_id,
        TRIM(NULLIF(b.hospitalregid, '')) AS patient_govt_id,

        b.patient_dob AS patient_date_of_birth,
        b.age,

        b.patient_created_by,
        TRIM(
            REGEXP_REPLACE(
                REGEXP_REPLACE(NULLIF(b.patient_created_by_name, ''), '[\.,\-]', ' ', 'g'),
                '\s+', ' ', 'g'
            )
        ) AS patient_created_by_name,

        b.patient_updated_by,
        TRIM(
            REGEXP_REPLACE(
                REGEXP_REPLACE(NULLIF(b.patient_updated_by_name, ''), '[\.,\-]', ' ', 'g'),
                '\s+', ' ', 'g'
            )
        ) AS patient_updated_by_name,

        TRIM(NULLIF(b.sub_type, '')) AS current_program,

        b.treatment_enrollment_start_date AS record_first_seen_at,
        b.treatment_action_processed_at   AS record_last_seen_at,

        b._source_system
    FROM dedup_bronze b
),

changed_patients AS (
    -- 3️⃣ find patients where something actually changed
    SELECT
        nb.*
    FROM normalized_bronze nb
    LEFT JOIN silver.dim_patient sp
        ON sp.patient_id = nb.patient_id
       AND sp._source_system = nb._source_system
       AND sp.is_current = TRUE
    WHERE
       sp.patient_sk IS NULL
       OR sp.patient_email_id IS DISTINCT FROM nb.patient_email_id
       OR sp.current_program IS DISTINCT FROM nb.current_program
)

-- 4️⃣ expire old rows
UPDATE silver.dim_patient sp
SET
    valid_to   = CURRENT_TIMESTAMP,
    is_current = FALSE
FROM changed_patients cp
WHERE sp.patient_id = cp.patient_id
  AND sp._source_system = cp._source_system
  AND sp.is_current = TRUE;

WITH dedup_bronze AS (
    SELECT *
    FROM (
        SELECT
            b.*,
            ROW_NUMBER() OVER (
                PARTITION BY b.patient_id, b._source_system
                ORDER BY b.treatment_action_processed_at DESC NULLS LAST,
                         b.index_no DESC
            ) AS rn
        FROM bronze.bronze_patient_treatment_actions b
        WHERE b.patient_id IS NOT NULL
    ) x
    WHERE rn = 1
),
normalized_bronze AS (
    SELECT
        b.patient_id,
        TRIM(NULLIF(b.patient_id_with_prefix, '')) AS patient_id_with_prefix,
        TRIM(REGEXP_REPLACE(REGEXP_REPLACE(b.patient_name, '[\.,\-]', ' ', 'g'), '\s+', ' ', 'g')) AS patient_name,
        LOWER(TRIM(b.patient_email_id)) AS patient_email_id,
        TRIM(b.hospitalregid) AS patient_govt_id,
        b.patient_dob AS patient_date_of_birth,
        b.age,
        b.patient_created_by,
        TRIM(b.patient_created_by_name) AS patient_created_by_name,
        b.patient_updated_by,
        TRIM(b.patient_updated_by_name) AS patient_updated_by_name,
        TRIM(b.sub_type) AS current_program,
        b.treatment_enrollment_start_date AS record_first_seen_at,
        b.treatment_action_processed_at AS record_last_seen_at,
        b._source_system
    FROM dedup_bronze b
),
changed_patients AS (
    SELECT nb.*
    FROM normalized_bronze nb
    LEFT JOIN silver.dim_patient sp
        ON sp.patient_id = nb.patient_id
       AND sp._source_system = nb._source_system
       AND sp.is_current = TRUE
    WHERE sp.patient_sk IS NULL
       OR sp.patient_email_id IS DISTINCT FROM nb.patient_email_id
       OR sp.current_program IS DISTINCT FROM nb.current_program
)

INSERT INTO silver.dim_patient (
    patient_id,
    patient_id_with_prefix,
    patient_name,
    patient_email_id,
    patient_govt_id,
    patient_date_of_birth,
    age,
    patient_created_by,
    patient_created_by_name,
    patient_updated_by,
    patient_updated_by_name,
    current_program,
    record_first_seen_at,
    record_last_seen_at,
    valid_from,
    valid_to,
    is_current,
    _source_system
)
SELECT
    patient_id,
    patient_id_with_prefix,
    patient_name,
    patient_email_id,
    patient_govt_id,
    patient_date_of_birth,
    age,
    patient_created_by,
    patient_created_by_name,
    patient_updated_by,
    patient_updated_by_name,
    current_program,
    record_first_seen_at,
    record_last_seen_at,
    CURRENT_TIMESTAMP,
    NULL,
    TRUE,
    _source_system
FROM changed_patients;


SELECT * FROM silver.dim_patient LIMIT 10;

SELECT * FROM silver.dim_patient LIMIT 10;
SELECT COUNT(*) FROM  silver.dim_patient;

SELECT * FROM  silver.dim_patient
WHERE patient_id='671771';

--silver.dim_caregiver table
INSERT INTO silver.dim_caregiver (
    caregiver_name,
    caregiver_relationship,
    identification_type,
    identification_value,
    record_first_seen_at,
    record_last_seen_at,
    _source_system
)
SELECT
    -- caregiver_name cleanup
    TRIM(
        REGEXP_REPLACE(
            REGEXP_REPLACE(NULLIF(b.guardian_name, ''), '[\.,\-]', ' ', 'g'),
            '\s+', ' ', 'g'
        )
    ) AS caregiver_name,

    TRIM(NULLIF(b.guardian_relationship, '')) AS caregiver_relationship,
    TRIM(NULLIF(b.guardian_identification_type, '')) AS identification_type,
    TRIM(NULLIF(b.guardian_identification_value, '')) AS identification_value,

    MIN(b.treatment_enrollment_start_date) AS record_first_seen_at,
    MAX(b.treatment_action_processed_at)   AS record_last_seen_at,

    MAX(b._source_system) AS _source_system
FROM bronze.bronze_patient_treatment_actions b
WHERE b.guardian_name IS NOT NULL
  AND TRIM(b.guardian_name) <> ''
GROUP BY
    TRIM(
        REGEXP_REPLACE(
            REGEXP_REPLACE(NULLIF(b.guardian_name, ''), '[\.,\-]', ' ', 'g'),
            '\s+', ' ', 'g'
        )
    ),
    TRIM(NULLIF(b.guardian_relationship, '')),
    TRIM(NULLIF(b.guardian_identification_type, '')),
    TRIM(NULLIF(b.guardian_identification_value, ''));

SELECT COUNT(*) FROM silver.dim_caregiver;
SELECT * FROM silver.dim_caregiver LIMIT 10;

--silver.dim_doctor table 
INSERT INTO silver.dim_doctor (
    doctor_name,
    external_doctor_id,
    source_system
)
SELECT DISTINCT
    TRIM(
        REGEXP_REPLACE(
            REGEXP_REPLACE(
                REGEXP_REPLACE(
                    LOWER(NULLIF(b.doctor_name, '')),
                    '^\s*dr\.?\s*', '', 'g'
                ),
                '[\.,\-]', ' ', 'g'
            ),
            '\s+', ' ', 'g'
        )
    ) AS doctor_name,

    TRIM(NULLIF(b.external_doctor_id, '')) AS external_doctor_id,

    b._source_system AS source_system
FROM bronze.bronze_patient_treatment_actions b
WHERE b.doctor_name IS NOT NULL
  AND TRIM(b.doctor_name) <> '';



SELECT COUNT(*) FROM silver.dim_doctor;
SELECT * FROM silver.dim_doctor LIMIT 10;

--silver.dim_hospital

INSERT INTO silver.dim_hospital (
    hospital_name,
    hospital_city,
    city_name,
    state_name,
    zones,
    pincode,
    address,
    source_system
)
SELECT DISTINCT
    /* -------------------------------
       Hospital name cleanup
       ------------------------------- */
    TRIM(
        REGEXP_REPLACE(
            REGEXP_REPLACE(
                REGEXP_REPLACE(
                    LOWER(NULLIF(b.treatment_action_hospital_name, '')),
                    '[\.,\-]', ' ', 'g'            -- remove punctuation
                ),
                '\s+[a-z]$|\s+\d+$', '', 'g'      -- remove trailing single letter OR number
            ),
            '\s+', ' ', 'g'                       -- collapse spaces
        )
    ) AS hospital_name,

    /* -------------------------------
       Hospital city (action level)
       ------------------------------- */
    TRIM(
        REGEXP_REPLACE(
            REGEXP_REPLACE(
                LOWER(NULLIF(b.treatment_action_hospital_city_name, '')),
                '[\.,\-]', ' ', 'g'
            ),
            '\s+', ' ', 'g'
        )
    ) AS hospital_city,

    /* -------------------------------
       City name (patient address city)
       ------------------------------- */
    TRIM(
        REGEXP_REPLACE(
            REGEXP_REPLACE(
                LOWER(NULLIF(b.city_name, '')),
                '[\.,\-]', ' ', 'g'
            ),
            '\s+', ' ', 'g'
        )
    ) AS city_name,

    /* -------------------------------
       State name
       ------------------------------- */
    TRIM(
        REGEXP_REPLACE(
            REGEXP_REPLACE(
                LOWER(NULLIF(b.state_name, '')),
                '[\.,\-]', ' ', 'g'
            ),
            '\s+', ' ', 'g'
        )
    ) AS state_name,

    /* -------------------------------
       Zone
       ------------------------------- */
    TRIM(
        REGEXP_REPLACE(
            LOWER(NULLIF(b.zones, '')),
            '\s+', ' ', 'g'
        )
    ) AS zones,

    /* -------------------------------
       Pincode (safe cast)
       ------------------------------- */
    CASE
        WHEN b.pincode IS NOT NULL
        THEN b.pincode
        ELSE NULL
    END AS pincode,

    /* -------------------------------
       Address – minimal normalization
       ------------------------------- */
    TRIM(
        REGEXP_REPLACE(
            NULLIF(b.address, ''),
            '\s+', ' ', 'g'
        )
    ) AS address,

    b._source_system AS source_system

FROM bronze.bronze_patient_treatment_actions b
WHERE b.treatment_action_hospital_name IS NOT NULL
  AND TRIM(b.treatment_action_hospital_name) <> '';

SELECT COUNT(*) FROM silver.dim_hospital;
SELECT * FROM silver.dim_hospital LIMIT 10;

--silver.dim_vendor_details
INSERT INTO silver.dim_vendor (
    vendor_name,
    vendor_email_id,
    source_system
)
SELECT DISTINCT
    -- Clean vendor name
    NULLIF(
        TRIM(
            REGEXP_REPLACE(
                REGEXP_REPLACE(
                    b.vendor_partner_name,
                    '[\.,\-]', ' ', 'g'
                ),
                '\s+', ' ', 'g'
            )
        ),
        ''
    ) AS vendor_name,

    -- Clean vendor email (trim only)
    NULLIF(TRIM(b.vendor_partner_email_id), '') AS vendor_email_id,

    b._source_system AS source_system

FROM bronze.bronze_patient_treatment_actions b
WHERE b.vendor_partner_name IS NOT NULL
  AND TRIM(b.vendor_partner_name) <> '';

SELECT COUNT(*) FROM silver.dim_vendor;   

SELECT * FROM silver.dim_vendor LIMIT 10;

SELECT patient_id, COUNT(*) FROM silver.dim_patient
GROUP BY patient_id
HAVING COUNT(*)>1

SELECT patient_id, patient_email_id, patient_govt_id,  COUNT(*) FROM silver.dim_patient

GROUP BY patient_id, patient_email_id, patient_govt_id

HAVING COUNT(*)>1;

SELECT * FROM silver.dim_patient LIMIT 10;

SELECT * FROM silver.dim_caregiver LIMIT 10;

SELECT * FROM silver.dim_doctor LIMIT 10;
SELECT caregiver_name, caregiver_relationship, identification_value, COUNT(*)
FROM silver.dim_caregiver
GROUP BY caregiver_name, caregiver_relationship, identification_value
HAVING COUNT(*)>1;

SELECT doctor_name, external_doctor_id, COUNT(*)  FROM silver.dim_doctor 
GROUP BY doctor_name, external_doctor_id 
HAVING COUNT(*)>1;

SELECT doctor_name, COUNT(*) FROM silver.dim_doctor
GROUP BY doctor_name
HAVING COUNT(*)>1;

SELECT doctor_name, external_doctor_id, COUNT(*) FROM silver.dim_doctor
WHERE external_doctor_id IS NULL
GROUP BY doctor_name, external_doctor_id
HAVING COUNT(*)>1;

SELECT * FROM silver.dim_hospital LIMIT 10;

SELECT hospital_name, pincode, COUNT(*) FROM silver.dim_hospital
GROUP BY hospital_name, pincode
HAVING COUNT(*)>1;

SELECT * FROM silver.dim_vendor LIMIT 10;

SELECT vendor_name, vendor_email_id, count(*) FROM silver.dim_vendor
GROUP BY vendor_name, vendor_email_id
HAVING COUNT(*)>1;


