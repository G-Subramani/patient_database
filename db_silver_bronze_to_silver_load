INSERT INTO silver.dim_patient (
    patient_id,
    patient_id_with_prefix,

    patient_name,
    patient_email_id,
    patient_govt_id,
    patient_date_of_birth,
    age,

    patient_created_by,
    patient_created_by_name,
    patient_updated_by,
    patient_updated_by_name,
    current_program,

    record_first_seen_at,
    record_last_seen_at,

    _source_system
)
SELECT
    b.patient_id,
    TRIM(NULLIF(b.patient_id_with_prefix, '')),

    -- patient_name (heavy cleanup)
    TRIM(
        REGEXP_REPLACE(
            REGEXP_REPLACE(NULLIF(b.patient_name, ''), '[\.,\-]', ' ', 'g'),
            '\s+', ' ', 'g'
        )
    ) AS patient_name,

    -- email normalization
    LOWER(TRIM(NULLIF(b.patient_email_id, ''))) AS patient_email_id,

    -- govt id (hospitalregid)
    TRIM(NULLIF(b.hospitalregid, '')) AS patient_govt_id,

    b.patient_dob AS patient_date_of_birth,
    b.age,

    b.patient_created_by,

    -- created by name cleanup
    TRIM(
        REGEXP_REPLACE(
            REGEXP_REPLACE(NULLIF(b.patient_created_by_name, ''), '[\.,\-]', ' ', 'g'),
            '\s+', ' ', 'g'
        )
    ) AS patient_created_by_name,

    b.patient_updated_by,

    -- updated by name cleanup
    TRIM(
        REGEXP_REPLACE(
            REGEXP_REPLACE(NULLIF(b.patient_updated_by_name, ''), '[\.,\-]', ' ', 'g'),
            '\s+', ' ', 'g'
        )
    ) AS patient_updated_by_name,

    TRIM(NULLIF(b.sub_type, '')) AS current_program,

    MIN(b.treatment_enrollment_start_date) AS record_first_seen_at,
    MAX(b.treatment_action_processed_at)   AS record_last_seen_at,

    MAX(b._source_system) AS _source_system
FROM bronze.bronze_patient_treatment_actions b
WHERE b.patient_id IS NOT NULL
GROUP BY
    b.patient_id,
    b.patient_id_with_prefix,
    b.patient_name,
    b.patient_email_id,
    b.hospitalregid,
    b.patient_dob,
    b.age,
    b.patient_created_by,
    b.patient_created_by_name,
    b.patient_updated_by,
    b.patient_updated_by_name,
    b.sub_type;

SELECT * FROM silver.dim_patient LIMIT 10;
SELECT COUNT(*) FROM  silver.dim_patient;
