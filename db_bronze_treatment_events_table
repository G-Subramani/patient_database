/*
===============================================================================
DDL Script : Create Bronze Tables for Treatment Events Data
Schema     : bronze
Database   : keytruda
Layer      : Bronze (Medallion Architecture)
===============================================================================

Script Purpose:
    - Creates Bronze layer table for patient treatment events data
    - Stores raw, immutable treatment action records

Design Principles:
    - Bronze layer is RAW and IMMUTABLE
    - Incremental loads only (append history)
    - No updates or deletes on business data
    - Staging sources may be reloadable
    - Supports Medallion Architecture (Bronze → Silver → Gold)

Re-runnable:
    YES
    - Schema created using IF NOT EXISTS
    - Table dropped and recreated to ensure clean DDL deployment

Ownership:
    Subramani G

===============================================================================
*/

CREATE SCHEMA IF NOT EXISTS bronze;

DROP TABLE IF EXISTS bronze.bronze_patient_treatment_actions CASCADE;

CREATE TABLE IF NOT EXISTS bronze.bronze_patient_treatment_actions (
	index_no BIGINT,
	patient_id BIGINT,
    patient_id_with_prefix TEXT,
    order_process_otps TEXT,
    order_process_otps_released_date TIMESTAMP,
    patient_name TEXT,
    patient_email_id TEXT,
    patient_dob DATE,
    treatment_id BIGINT,
    treatment_status TEXT,
    treatment_enrollment_start_date DATE,
    treatment_action_id BIGINT,
    treatment_action_status TEXT,
    treatment_action_type TEXT,
    treatment_end_date DATE,
    treatment_end_reason TEXT,
    treatment_end_sub_reason TEXT,
    guardian_name TEXT,
    guardian_relationship TEXT,
    guardian_identification_type TEXT,
    guardian_identification_value TEXT,
    vendor_partner_name TEXT,
    vendor_partner_email_id TEXT,
    followup_date TIMESTAMP,
    doctor_name TEXT,
    external_doctor_id TEXT,
    treatment_hospital_name TEXT,
    treatment_hospital_city_name TEXT,
    treatment_action_hospital_name TEXT,
    treatment_action_hospital_city_name TEXT,
    medicine TEXT,
    dosage INTEGER,
    user_name TEXT,
    treatment_tags TEXT,
    notes TEXT,
    hospitalregid TEXT,
    sub_type TEXT,
    action_medicine_details_medicine_name TEXT,
    action_medicine_details_quantity INTEGER,
    action_medicine_details_dosage INTEGER,
    action_pharma_info_doctor_name TEXT,
    action_pharma_info_expected_delivery_date DATE,
    action_pharma_info_mode_of_delivery TEXT,
    address TEXT,
    cityname TEXT,
    pincode INTEGER,
    effective_cycle_count INTEGER,
    effective_purchase_count INTEGER,
    effective_sub_type TEXT,
    expected_delivery_dosage INTEGER,
    treatment_dosage INTEGER,
    treatment_dosage_type INTEGER,
    patient_created_by TEXT,
    patient_updated_by TEXT,
    patient_created_by_name TEXT,
    patient_updated_by_name TEXT,
    treatment_action_processed_at TIMESTAMP,
    previous_action_processed_at_date TIMESTAMP,
    days_difference_prev_processed_at_to_current_processed_at NUMERIC,
    infusion_confirmation_exists TEXT,
    infusion_confirmation_status TEXT,
    infusion_confirmation_created_at TIMESTAMP,
    next_cycle_icf_exists TEXT,
    next_cycle_icf_status TEXT,
    next_cycle_icf_created_at TIMESTAMP,
    next_cycle_icf_comments TEXT,
    age INTEGER,
    zones TEXT,
    city_name TEXT,
    state_name TEXT,
    --metadata columns (Bronze standard)
	_source_extract_date date NOT NULL,
    _ingestion_timestamp timestamp without time zone NOT NULL DEFAULT now(),
    _source_system text NOT NULL,
    _file_name text 

);

--sample validation
SELECT * FROM bronze.bronze_patient_treatment_actions LIMIT 10;

--Appointment data 

DROP TABLE bronze.bronze_appointment_events CASCADE;

CREATE TABLE IF NOT EXISTS bronze.bronze_appointment_events (

	appointment_date date,
	area text, 
	roll_up_city text, 
	referrer_name text,
	referrer_source text, 
	referrer_bucket text,
	referrer_type text,
	clinic_name text,
	paramedic text, 
	master_referrer_doctor text,
	appt_referred_by_name text,
	appt_sales_executive_name text,
	service text, 
	clinician_name text, 
	emp_type text,
	clinician_vendor_master_id text,
	clinician_vendor_master_name text,
	clinician_id bigint,
	emp_id text,
	clinician_user_id bigint,
	reporting_manager text,
	appointment_created_by_id bigint,
	appointment_created_by_name text,
	appointment_created_on timestamp,
	patient_name text,
	appointment_cost numeric,
	other_charges numeric,
	other_charges_desc text,
	appointment_service_charges numeric,
	appointment_discount numeric,
	discount_type text,
	total_fee numeric,
	status text,
	package_name_empty text,
	patient_id bigint,
	patient_user_id bigint,
	service_balance text,
	package_balance text,
	package_id bigint,
	offered_price numeric,
	mrp numeric,
	package_discount numeric,
	hospital_regid text, 
	appointment_id bigint,
	first_successful_appt_date date,
	first_successful_appt_id bigint,
	next_appt_id bigint,
	patient_type text,
	sales_executive text,
	sales_executive_id text,
	amount_paid numeric,
	package_name text,
	service_type_id integer,
	app_start_time timestamp,
	app_end_time timestamp,
	service_category text, 
	collection_charges numeric,
	revenue numeric,
	 appt_referrer_name text,
	appt_referred_by text,
	appt_reference_from text, 
	appt_department text,
	bill_to_id bigint,
	appt_sales_executive text, 
	appt_referrer_source text,
	appt_referrer_bucket text,
	appt_referred_type text,
	appt_referrer_brand_name text,
	patient_brand_name text,
	patient_package_id bigint,
	subscription_ticket_id text,
	appt_patient_address_state text,
	patient_reference_form text,
	revenue_hospital_id text,
	revenue_hospital_name text,
	patient_with_us_since text,
	revenue_bdo_id text,
	revenue_bdo_name text,
	revenue_doctor_id text,
	revenue_doctor_name text,
	revenue_clinician_id text,
	revenue_clinician_name text,
	revenue_category text,
	subscription_start_date date,
	first_clinical_app_date timestamp,

	
	--metadata columns (Bronze standard)
	_source_extract_date date,
	_ingestion_timestamp timestamp without time zone NOT NULL DEFAULT now(), 
	_source_system text,
	_file_name text

);

SELECT * FROM bronze.bronze_appointment_events LIMIT 10;
